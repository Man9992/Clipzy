<!doctype html>

<html lang="en">

<head>

<meta charset="utf-8"/>

<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

<title>Clipzy ‚Äî Shared For You</title>

<meta name="theme-color" content="#000"/>

<style>

:root{--bg:#000;--muted:#9ca3af;--accent:#ff0044}

html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#fff;background:var(--bg)}

.app{height:100vh;max-width:720px;margin:0 auto;position:relative;overflow:hidden}

.viewport{height:100%;width:100%;position:relative;touch-action:none;user-select:none;background:#000}

.slot{position:absolute;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;transition:transform 320ms cubic-bezier(.2,.9,.2,1),opacity 220ms}

video,img{max-height:100%;max-width:100%;display:block;object-fit:cover}

.topbar{position:absolute;left:0;right:0;top:16px;display:flex;justify-content:center;pointer-events:none}

.title{background:rgba(0,0,0,0.35);padding:6px 12px;border-radius:20px;font-weight:600}

.bottombar{position:absolute;left:16px;bottom:22px;right:16px;display:flex;align-items:flex-end;justify-content:space-between;pointer-events:none}

.nick{background:rgba(0,0,0,0.35);padding:8px 10px;border-radius:10px;font-weight:600;font-size:14px;pointer-events:auto}

.actions{position:absolute;right:12px;bottom:28px;display:flex;flex-direction:column;gap:12px;pointer-events:auto}

.dotbtn{width:52px;height:52px;border-radius:999px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.04)}

.dotbtn svg{width:22px;height:22px;fill:#fff}

.sheet{position:fixed;left:0;right:0;bottom:-100%;background:linear-gradient(180deg,#071122,#000);border-top-left-radius:12px;border-top-right-radius:12px;padding:14px;box-shadow:0 -8px 30px rgba(0,0,0,0.6);transition:bottom 320ms cubic-bezier(.2,.9,.2,1);z-index:40}

.sheet.open{bottom:0}

.sheet .row{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}

.sheet button{background:transparent;border:0;color:#fff;padding:10px 8px;font-weight:600;font-size:15px;flex:1;text-align:left}

.small{font-size:12px;color:var(--muted);padding-left:8px}

.like-badge{position:absolute;left:16px;bottom:110px;background:rgba(0,0,0,0.45);padding:8px 10px;border-radius:999px;font-weight:700;display:flex;gap:8px;align-items:center;pointer-events:none}

.big-heart{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(0);opacity:0;pointer-events:none;font-size:110px;color:rgba(255,0,68,0.95);transition:transform 380ms cubic-bezier(.2,.9,.2,1),opacity 300ms}

.big-heart.show{transform:translate(-50%,-50%) scale(1);opacity:1}

input[type=file]{display:none}

.tiny{font-size:12px;color:var(--muted)}

.bottom-hint{position:absolute;left:0;right:0;bottom:12px;text-align:center;color:var(--muted);pointer-events:none;font-size:12px}

</style>

</head>

<body>

<div class="app" id="app" role="application" aria-label="Clipzy shared For You">

  <div class="viewport" id="viewport" tabindex="0"></div>

  <div class="topbar"><div class="title">For You ‚Ä¢ Clipzy</div></div>

  <div class="bottombar">

    <div id="nickWrap" style="pointer-events:auto">

      <div id="nickname" class="nick">anon</div>

    </div>

    <div class="actions">

      <div class="dotbtn" id="dotBtn" title="Menu" aria-label="Open menu">

        <svg viewBox="0 0 24 24"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>

      </div>

    </div>

  </div>

  <div class="like-badge" id="likeBadge"><span style="color:var(--accent);font-weight:900">‚ù§</span><span id="likeCount">0</span></div>

  <div class="big-heart" id="bigHeart">‚ù§</div>

  <div class="bottom-hint tiny">Swipe ‚Üë / ‚Üì ‚Ä¢ Double-tap to like ‚Ä¢ Tap ‚Ä¢‚Ä¢‚Ä¢ for menu</div>

  <input id="fileInput" type="file" accept="video/*,video/webm,video/mp4,image/*">

  <input id="importInput" type="file" accept="application/json">

  <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-hidden="true">

    <div style="width:40px;height:4px;background:rgba(255,255,255,0.06);border-radius:999px;margin:6px auto"></div>

    <div class="sheet-inner" id="sheetInner">

      <div class="row"><button id="menuUpload">üì§ Upload Clip</button><div class="small tiny">Choose a file</div></div>

      <div class="row"><button id="menuRecord">üé• Record Clip</button><div class="small tiny">Use camera (12s auto)</div></div>

      <div class="row"><button id="menuSetNick">‚úèÔ∏è Set Nickname</button><div class="small tiny">Optional display name</div></div>

      <div class="row"><button id="menuLike">‚ù§ Like / Unlike</button><div class="small tiny">Double-tap works too</div></div>

      <div class="row"><button id="menuShare">‚¨ÜÔ∏è Share / Download</button><div class="small tiny">Save clip</div></div>

      <div class="row"><button id="menuDelete" style="color:#ff7b7b">üóëÔ∏è Delete (local)</button><div class="small tiny">Removes clip from this device</div></div>

      <div class="row"><button id="menuExport">üíæ Export Clips (.json)</button><div class="small tiny">Share your local feed</div></div>

      <div class="row"><label for="importInput" style="width:100%;display:block"><button id="menuImport">üì• Import Clips (.json)</button><div class="small tiny">Load clips from friends</div></label></div>

      <div class="row"><button id="menuClose">‚úñ Close</button><div class="small tiny">Back to feed</div></div>

    </div>

  </div>

</div>

<!-- Firebase compat SDKs for single-file simplicity -->

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>

/* ====== PASTE YOUR FIREBASE CONFIG OBJECT HERE ======

  Replace the FIREBASE_CONFIG below with your Firebase web app config.

  EXAMPLE (do not paste keys into chat; paste them here in your local file):

const FIREBASE_CONFIG = {

¬† apiKey: "AIzaSyDDmpF__K0xzkQSJ-buEBAaHjJseT9nAE8",

¬† authDomain: "clipzy-ec330.firebaseapp.com",

¬† projectId: "clipzy-ec330",

¬† storageBucket: "clipzy-ec330.firebasestorage.app",

¬† messagingSenderId: "227715602469",

¬† appId: "1:227715602469:web:0002fcd4cb8835a170c7cc",

¬† measurementId: "G-0M2ER8MS37"

};

=====================================================*/

const FIREBASE_CONFIG = {

  apiKey: "FIREBASE_APIKEY",

  authDomain: "FIREBASE_AUTHDOMAIN",

  projectId: "FIREBASE_PROJECTID",

  storageBucket: "FIREBASE_STORAGEBUCKET",

  messagingSenderId: "FIREBASE_MSG_SENDER",

  appId: "FIREBASE_APPID"

};

/* ==================================================== */

firebase.initializeApp(FIREBASE_CONFIG);

const auth = firebase.auth();

const storage = firebase.storage();

const db = firebase.firestore();

async function ensureAuth(){ if(!auth.currentUser) try{ await auth.signInAnonymously(); }catch(e){ console.warn('auth',e); } }

ensureAuth();

/* ----------------- APP LOGIC (same as previous full version) ----------------- */

const $ = id => document.getElementById(id);

const viewport = $('viewport'), sheet = $('sheet'), dotBtn = $('dotBtn');

const fileInput = $('fileInput'), importInput = $('importInput');

let anonId = localStorage.getItem('clipzy_anonid');

if(!anonId){ anonId = 'anon_' + (crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36)); localStorage.setItem('clipzy_anonid', anonId); }

$('nickname').textContent = localStorage.getItem('clipzy_nick') || anonId.slice(0,8);

let clips = [], currentIndex = 0;

// Subscribe to public feed in Firestore

function subscribePublicFeed(onUpdate){

  return db.collection('clips')

    .where('status','==','public')

    .orderBy('created','desc')

    .limit(200)

    .onSnapshot(snap=>{

      const arr = [];

      snap.forEach(d=>{ const data = d.data(); data.id = d.id; arr.push(data); });

      onUpdate(arr);

    }, err => console.error('feed err', err));

}

function makeSlot(clip, idx, pos){

  const slot = document.createElement('div'); slot.className = 'slot';

  slot.dataset.index = idx; slot.style.transform = `translateY(${pos*100}%)`; slot.style.opacity = pos===0?1:0.95;

  if(clip.type && clip.type.startsWith('image/')){

    const img = document.createElement('img'); img.src = clip.downloadURL || clip.data; slot.appendChild(img);

  } else {

    const v = document.createElement('video'); v.src = clip.downloadURL || clip.data; v.setAttribute('playsinline',''); v.muted = true; v.loop = true; v.preload='auto'; slot.appendChild(v);

  }

  return slot;

}

function clearViewport(){ viewport.innerHTML = ''; }

function rebuildSlots(){ clearViewport(); const prev = clips[currentIndex-1], cur = clips[currentIndex], next = clips[currentIndex+1]; if(prev) viewport.appendChild(makeSlot(prev,currentIndex-1,-1)); if(cur) viewport.appendChild(makeSlot(cur,currentIndex,0)); if(next) viewport.appendChild(makeSlot(next,currentIndex+1,1)); updateOverlays(); autoplayCurrent(); }

function updateOverlays(){ const cur = clips[currentIndex]; $('nickname').textContent = cur ? (cur.nick || 'anon') : (localStorage.getItem('clipzy_nick') || anonId.slice(0,8)); $('likeCount').textContent = cur ? (cur.likes || 0) : 0; }

function autoplayCurrent(){ const vids = viewport.querySelectorAll('video'); vids.forEach(v=>{ try{ v.pause(); }catch{} }); const curSlot = viewport.querySelector('.slot[data-index="'+currentIndex+'"]'); if(!curSlot) return; const v = curSlot.querySelector('video'); if(v){ const p = v.play(); if(p && p.catch) p.catch(()=>{}); v.muted = true; } }

let unsubscribeFeed = null;

function startFeed(){ if(unsubscribeFeed) unsubscribeFeed(); unsubscribeFeed = subscribePublicFeed(arr=>{ clips = arr.sort(()=>Math.random()-0.5); currentIndex = 0; rebuildSlots(); }); }

startFeed();

function clampIndex(i){ if(i<0) return 0; if(i>clips.length-1) return clips.length-1; return i; }

async function goToIndex(i){ if(clips.length===0) return; currentIndex = clampIndex(i); const slots = viewport.querySelectorAll('.slot'); slots.forEach(s=>{ const idx = Number(s.dataset.index); const pos = idx - currentIndex; s.style.transform = `translateY(${pos*100}%)`; s.style.opacity = pos===0?1:0.95; }); setTimeout(()=>rebuildSlots(),280); updateOverlays(); }

let startY=null, startTime=null;

viewport.addEventListener('touchstart', e=>{ startY = e.touches[0].clientY; startTime = Date.now(); },{passive:true});

viewport.addEventListener('touchmove', e=>{ e.preventDefault(); },{passive:false});

viewport.addEventListener('touchend', e=>{ if(startY===null) return; const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : null; const dy = endY - startY; const dt = Date.now() - startTime; startY=null; if(Math.abs(dy)>60 && dt<600){ if(dy<0) goToIndex(currentIndex+1); else goToIndex(currentIndex-1); } },{passive:true});

viewport.addEventListener('wheel', e=>{ if(e.deltaY>20) goToIndex(currentIndex+1); else if(e.deltaY<-20) goToIndex(currentIndex-1); });

let lastTap = 0;

viewport.addEventListener('click', async ()=>{ const now = Date.now(); if(now - lastTap < 300){ await toggleLikeCurrent(); showBigHeart(); } lastTap = now; });

function showBigHeart(){ const b = $('bigHeart'); b.classList.add('show'); setTimeout(()=>b.classList.remove('show'),700); }

dotBtn.addEventListener('click', ()=> openSheet(true));

$('menuClose').addEventListener('click', ()=> openSheet(false));

function openSheet(show){ if(show){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); } else { sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); } }

$('menuUpload').addEventListener('click', ()=> fileInput.click());

fileInput.addEventListener('change', async e=>{

  const f = e.target.files[0]; if(!f) return;

  try{ await handleLocalOrCloudUpload(f); fileInput.value=''; openSheet(false); }catch(err){ alert('Upload failed: '+err.message); console.error(err); fileInput.value=''; }

});

$('menuRecord').addEventListener('click', async ()=>{

  openSheet(false);

  if(!navigator.mediaDevices || !window.MediaRecorder){ alert('Recording not supported'); return; }

  try{

    const stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user'}, audio:true });

    const recorder = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp8' });

    const chunks = [];

    recorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };

    recorder.onstop = async ()=>{ const blob = new Blob(chunks, { type: 'video/webm' }); await handleLocalOrCloudUpload(blob); stream.getTracks().forEach(t=>t.stop()); startFeed(); };

    recorder.start();

    alert('Recording started ‚Äî will auto-stop after 12s. Tap OK to stop early.');

    setTimeout(()=>{ if(recorder.state==='recording') recorder.stop(); }, 12000);

  }catch(err){ console.error(err); alert('Camera error or permission denied'); }

});

$('menuSetNick').addEventListener('click', ()=>{

  const n = prompt('Enter short nickname (optional):', localStorage.getItem('clipzy_nick')||'');

  if(n!==null){ localStorage.setItem('clipzy_nick', n.trim().slice(0,24)); $('nickname').textContent = n.trim()||anonId.slice(0,8); }

});

$('menuLike').addEventListener('click', async ()=>{ await toggleLikeCurrent(); openSheet(false); });

$('menuShare').addEventListener('click', async ()=>{ await shareCurrent(); openSheet(false); });

$('menuDelete').addEventListener('click', async ()=>{

  if(!confirm('Delete this clip from this device?')) return;

  alert('Local deletion from UI only ‚Äì global deletion requires server-side action.');

  openSheet(false);

});

$('menuExport').addEventListener('click', async ()=>{ await exportClips(); openSheet(false); });

$('importInput').addEventListener('change', async e=>{ const f = e.target.files[0]; if(!f) return; await importClipsFromFile(f); e.target.value=''; openSheet(false); });

async function handleLocalOrCloudUpload(fileOrBlob){

  let duration = null;

  if((fileOrBlob.type && fileOrBlob.type.startsWith('video/')) || fileOrBlob instanceof Blob){

    const url = URL.createObjectURL(fileOrBlob);

    const temp = document.createElement('video'); temp.preload='metadata'; temp.src = url;

    await new Promise(res=> temp.onloadedmetadata = res);

    duration = Math.round(temp.duration || 0);

    URL.revokeObjectURL(url);

  }

  const doCloud = confirm('Upload to global Clipzy feed so everyone can see it? OK = yes, Cancel = local only.');

  if(doCloud){

    await ensureAuth();

    const file = fileOrBlob instanceof File ? fileOrBlob : new File([fileOrBlob], ('clip_'+Date.now()+'.webm'), { type: fileOrBlob.type || 'video/webm' });

    const nick = localStorage.getItem('clipzy_nick') || '';

    await uploadToFirebase(file, { nick, duration });

    startFeed();

  } else {

    alert('Local-only uploads are supported in the offline prototype. Use that version if you want local-only storage.');

  }

}

// Upload to Firebase Storage + Firestore

async function uploadToFirebase(file, meta){

  await ensureAuth();

  const uid = auth.currentUser ? auth.currentUser.uid : null;

  if(!uid) throw new Error('Auth required');

  if(file.size > 10 * 1024 * 1024) throw new Error('File too large (limit 10MB)');

  const id = 'c_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);

  const pendingPath = `pending/${id}.webm`;

  const storageRef = storage.ref(pendingPath);

  const putTask = storageRef.put(file, { contentType: file.type });

  return new Promise((resolve,reject)=>{

    putTask.on('state_changed',

      snap => {},

      err => reject(err),

      async () => {

        const downloadURL = await storageRef.getDownloadURL();

        const doc = {

          id,

          storagePath: pendingPath,

          downloadURL,

          nick: meta.nick || '',

          created: firebase.firestore.FieldValue.serverTimestamp(),

          likes: 0,

          uploaderUid: uid,

          status: 'public',

          duration: meta.duration || null

        };

        await db.collection('clips').doc(id).set(doc);

        resolve(doc);

      }

    );

  });

}

async function toggleLikeCurrent(){

  const cur = clips[currentIndex]; if(!cur) return;

  const docRef = db.collection('clips').doc(cur.id);

  try{

    await db.runTransaction(async tx=>{

      const doc = await tx.get(docRef);

      if(!doc.exists) return;

      const curLikes = doc.data().likes || 0;

      tx.update(docRef, { likes: curLikes + 1 });

    });

    cur.likes = (cur.likes || 0) + 1;

    $('likeCount').textContent = cur.likes;

    rebuildSlots();

  }catch(err){ console.error('like failed', err); }

}

async function shareCurrent(){

  const cur = clips[currentIndex]; if(!cur) return;

  if(cur.downloadURL && navigator.share){

    try{ await navigator.share({ title: cur.nick || 'Clipzy', url: cur.downloadURL }); return; } catch(e) {}

  }

  if(cur.downloadURL){ const a = document.createElement('a'); a.href = cur.downloadURL; a.download = (cur.nick || 'clip') + '_' + cur.id + '.webm'; a.click(); return; }

  alert('No downloadable URL available for this clip.');

}

async function exportClips(){

  const snap = await db.collection('clips').where('status','==','public').orderBy('created','desc').limit(200).get();

  const arr = []; snap.forEach(d=>{ const data = d.data(); data.id = d.id; arr.push(data); });

  const payload = { exportedAt: Date.now(), clips: arr, source: 'clipzy' };

  const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });

  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'clipzy_public_export_'+Date.now()+'.json'; a.click();

  setTimeout(()=>URL.revokeObjectURL(a.href), 5000);

}

async function importClipsFromFile(file){

  try{

    const txt = await file.text();

    const obj = JSON.parse(txt);

    if(!obj.clips || !Array.isArray(obj.clips)) { alert('Invalid import file'); return; }

    clips = (obj.clips.concat(clips)).slice(0,200);

    currentIndex = 0;

    rebuildSlots();

    alert('Imported ' + obj.clips.length + ' clips (metadata).');

  }catch(err){ console.error(err); alert('Import failed'); }

}

/* lightweight service worker blob */

if('serviceWorker' in navigator){

  const swCode = `self.addEventListener('install', e=>self.skipWaiting()); self.addEventListener('activate', e=>self.clients.claim()); self.addEventListener('fetch', e=>{ e.respondWith(fetch(e.request).catch(()=>caches.match(e.request))); });`;

  const swBlob = new Blob([swCode], { type: 'application/javascript' });

  const swUrl = URL.createObjectURL(swBlob);

  navigator.serviceWorker.register(swUrl).catch(()=>{/* ignore */});

}

</script>

</body>

</html>